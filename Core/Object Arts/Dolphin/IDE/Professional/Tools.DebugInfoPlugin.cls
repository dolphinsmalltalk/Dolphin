"Filed out from Dolphin Smalltalk"!

Tools.ClassBrowserPlugin
	subclass: #'Tools.DebugInfoPlugin'
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Tools.DebugInfoPlugin guid: (Core.GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!
Tools.DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!
!Tools.DebugInfoPlugin categoriesForClass!Browser-Plugins! !
!Tools.DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: SmalltalkSystem current workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: SmalltalkSystem current methodWorkspaceClass new name: 'source'.
	sourcePresenter
		isAutoParseEnabled: false;
		isSelectionMatched: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	self model
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	method selector: method selector asSymbol.
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aPuttableStream
	"Append to the <puttableStream> first argument a String whose characters are a representation of the receiver that an end-user might want to see.
	This will be used as the label for the tab when the receiver is being displayed as a plugin within the Class Browser."

	aPuttableStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags | (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler
		compile: aCompiledMethod getSource
		in: methodClass
		environment: aCompiledMethod environment
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !
!Tools.DebugInfoPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!private! !
displayOn:!displaying!public! !
getDebugInfoFor:!private! !
onBrowserClassSelected!event handling!public! !
onBrowserMethodSelected!event handling!public! !
onTextMapEntrySelected!private! !
parseContext!public! !
selectedMethod!public! !
toggleDebug!public! !
!

!Tools.DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	Tools.ViewComposer openOn: (UI.ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 6 2118 10 #{UI.STBViewProxy} #{UI.ContainerView} 38 #{Core.Array} 15 nil nil 50 2 8 1409286144 131073 32 nil nil nil 5 nil nil nil 32 518 #{UI.ProportionalLayout} 550 #{Core.LookupTable} 4 18 #{UI.ContainerView} 50 15 nil 32 50 2 8 1140850688 131073 176 nil nil nil 5 nil nil nil 176 1798 #{UI.BorderLayout} 1 1 18 #{UI.ContainerView} 50 15 nil 176 50 2 8 1140850688 131073 272 nil nil nil 517 nil nil nil 272 838 1 #{UI.FlowLayout} 11 1 1 550 #{Core.IdentityDictionary} 2 18 #{UI.CheckBox} 50 16 nil 272 50 2 8 1409363203 1 400 1094 2 #{UI.ValueHolder} nil nil 6 #{Kernel.NeverSearchPolicy} false nil nil 517 nil nil nil 400 nil 8 1853182784 518 #{UI.NullConverter} nil nil nil 262 #{Core.MessageSequence} 50 2 774 #{Core.MessageSend} #createAt:extent: 50 2 518 #{Graphics.Point} 141 7 674 169 39 400 626 #text: 50 1 8 'Optimised?' 400 262 #{OS.WINDOWPLACEMENT} 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 70 0 0 0 3 0 0 0 154 0 0 0 22 0 0 0] 8 #() 674 193 193 nil 27 8 'optimisedToggle' 18 #{UI.CheckBox} 50 16 nil 272 50 2 8 1409363203 1 864 466 nil nil 512 false nil nil 517 nil nil nil 864 nil 8 1853182784 546 nil nil nil 578 50 2 626 #createAt:extent: 50 2 674 5 7 674 127 39 864 626 #text: 50 1 8 'Debug?' 864 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 2 0 0 0 3 0 0 0 65 0 0 0 22 0 0 0] 8 #() 832 nil 27 8 'debugToggle' 518 #{Graphics.Rectangle} 674 5 7 674 1 7 578 50 1 626 #createAt:extent: 50 2 674 1 1 674 317 51 272 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 50 2 864 400 832 nil 27 nil nil nil 18 #{UI.ListView} 50 45 nil 176 50 2 8 1409388621 1 1392 838 2 #{UI.ListModel} 550 #{Core.OrderedCollection} 0 nil 6 #{Kernel.IdentitySearchPolicy} 6 #{Graphics.Color} #default nil 5 nil nil nil 1392 nil 8 1853243664 518 #{Core.Message} #displayString 8 #() nil 1350 1 #{Graphics.IconImageManager} nil nil nil nil nil nil 1490 2 3142 5 #{UI.ListViewColumn} 8 'IP' 87 #left 1602 #displayString 1632 1602 #<= 8 #() 1602 #key 8 #() nil 1392 nil 1 nil nil 1698 8 'Range' 231 #left 1602 #displayString 8 #() 1602 #<= 1872 1602 #value 1808 nil 1392 nil 3 nil nil #report 8 #() nil 131169 nil 1 nil nil nil nil 1 nil nil nil nil nil nil nil nil nil nil 578 50 2 626 #createAt:extent: 50 2 674 1 51 674 317 691 1392 626 #text: 50 1 8 'IP' 1392 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 8 #() 832 nil 35 370 1 1392 8 'textMap' 1186 674 1 1 674 5 1 578 50 1 626 #createAt:extent: 50 2 674 1 1 674 321 741 176 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 50 2 272 1392 832 nil 27 1 18 #{UI.Scintilla.ScintillaView} 50 56 nil 32 50 2 8 1445007684 1 2352 nil 1568 nil 21 2886 4 #{UI.Menu} nil true 50 9 2418 nil true 50 3 1094 2 #{UI.CommandMenuItem} 1 1350 4 #{UI.CommandDescription} #copySelection 8 '&Copy' 1 1 838 4 #{Graphics.Icon} nil true 1030 #{Graphics.ImageFromStringResourceInitializer} 8 'EditCopy.ico' 838 1 #{External.ResourceLibrary} 8 'dolphindr8.dll' 65541 nil nil nil 326 1 #{UI.DividerMenuItem} 4097 2498 1 2530 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 2418 nil true 50 6 2498 1 2530 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 2498 1 2530 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 2498 1 2530 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 2498 1 2530 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 2498 1 2530 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 2498 1 2530 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 2706 4097 2498 1 2530 #browseIt 8 'Bro&wse It' 1 1 2578 nil true 2610 8 'ClassBrowserShell.ico' 2672 65541 nil nil nil 2498 1 2530 #evaluateIt 8 'E&valuate It' 1 1 2578 nil true 2610 8 'EvaluateIt.ico' 2672 65541 nil nil nil 2498 1 2530 #inspectIt 8 '&Inspect It' 1 1 2578 nil true 2610 8 'InspectIt.ico' 2672 65541 nil nil nil 2498 1 2530 #debugIt 8 'Deb&ug It' 1 1 2578 nil true 2610 8 'Debugger.ico' 2672 65541 nil nil nil 2706 4097 2418 nil true 50 4 2498 2097153 2530 #browseDefinitions 8 'Defi&nitions of <1d>' 1 1 nil nil nil 2498 1 2530 #browseReferences 8 '&References to <1d>' 1 1 nil nil nil 2706 4097 2498 1 2530 #browseMessage 8 '<1d>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 2352 nil 8 1367644576 546 nil nil 11 #focusLost nil nil nil nil 370 2 #callTip 3142 1 #{UI.Scintilla.TextStyle} 77 1554 #gray 1554 #white 1 nil nil nil nil #callTip nil nil nil #normal 3826 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1286 #{Tools.SmalltalkMethodStyler} 1 nil nil false 1490 0 370 1 #default 3142 2 #{UI.Scintilla.MarkerDefinition} 1 nil nil nil 2352 #circle nil nil nil nil nil nil 294 #{Core.IdentitySet} 0 nil 146 0 9215 nil nil 146 1 81 1554 #windowText nil nil 262 #{UI.Scintilla.NullScintillaLibrary} nil 65 nil nil 370 3 #literalArray 8 '()' #literalBytes 8 '[]' #specialCharacter 8 '()[]<>' nil 3 370 1 #container 3808 nil nil nil nil #{Core.Utf8String} nil 370 2 #Error 3142 5 #{UI.Scintilla.IndicatorDefinition} 19 2352 1554 #red 3 3 #Error nil nil nil nil nil nil #Warning 4210 17 2352 1554 #blue 3 3 #Warning nil nil nil nil nil nil nil nil 370 3 #Error 3826 1031 1554 #firebrick 1554 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 3826 1029 nil 1554 #gainsboro 1 nil nil nil nil #Notification nil nil nil #Warning 3826 1027 1554 #darkGoldenrod 1554 #ivory 1 nil nil nil nil #Warning nil nil nil nil nil nil 578 50 9 626 #createAt:extent: 50 2 674 323 1 674 619 741 2352 626 #sciSetMouseDwellTime: 8 #(500) 2352 626 #wordWrap: 8 #(true) 2352 626 #margins: 50 1 50 3 2118 3 #{UI.Scintilla.Margin} 1 2352 33 3 nil nil nil nil 4642 3 2352 nil nil nil 67108863 nil nil 4642 5 2352 nil nil nil nil nil nil 2352 626 #backspaceUnindents: 8 #(true) 2352 626 #maxCompletionListHeight: 8 #(9) 2352 626 #sciSetTechnology: 8 #(1) 2352 626 #sciSetFontQuality: 8 #(3) 2352 626 #sciSetSelectionLayer: 8 #(1) 2352 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 8 #() 832 nil 45 9 18 #{UI.Scintilla.ScintillaView} 50 56 nil 32 50 2 8 1174475012 1 4912 466 nil false 6 #{Kernel.EqualitySearchPolicy} nil 1554 #highlight3d nil 1045 nil nil nil 4912 nil 8 1367644576 546 nil nil 11 #focusLost nil nil nil nil 370 5 #callTip 3826 77 3856 3872 1 nil nil nil nil #callTip nil nil nil #indentGuide 3826 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #lineNumber 3826 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #normal 3826 1 nil nil 1 nil nil nil nil #normal nil nil nil #whitespace 3826 3 nil nil 1 nil nil nil nil #whitespace nil nil nil nil 326 1 #{UI.Scintilla.NullStyler} #normal 370 1 #default 3970 1 nil nil nil 4912 #circle nil nil nil nil nil nil 4002 0 nil 146 0 9215 nil nil 146 1 81 4064 nil nil 4096 nil 65 nil nil nil nil 1 370 1 #container 5072 nil nil nil nil #{Core.Utf8String} nil 370 0 nil nil 370 3 #Error 3826 1031 4320 4336 1 nil nil nil nil #Error nil nil nil #Notification 3826 1029 nil 4368 1 nil nil nil nil #Notification nil nil nil #Warning 3826 1027 4400 4416 1 nil nil nil nil #Warning nil nil nil nil nil nil 578 50 8 626 #createAt:extent: 50 2 674 951 1 674 621 741 4912 626 #wordWrap: 8 #(true) 4912 626 #margins: 50 1 50 3 4642 1 4912 nil 3 nil nil nil nil 4642 3 4912 nil nil nil 67108863 nil nil 4642 5 4912 nil nil nil nil nil nil 4912 626 #sciSetHScrollBar: 8 #(false) 4912 626 #maxCompletionListHeight: 8 #(9) 4912 626 #sciSetTechnology: 8 #(1) 4912 626 #sciSetFontQuality: 8 #(3) 4912 626 #sciSetSelectionLayer: 8 #(1) 4912 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 8 #() 832 nil 45 9 18 #{UI.StaticRectangle} 50 14 nil 32 50 2 8 1140850952 1 5808 nil 1568 nil 5 nil nil nil 5808 nil 8 1853387904 578 50 2 626 #createAt:extent: 50 2 674 321 1 674 3 741 5808 626 #isEnabled: 8 #(false) 5808 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 8 #() 832 nil 27 1 false 370 2 2352 8 'source' 4912 8 'disassembly' nil 578 50 1 626 #createAt:extent: 50 2 674 6143 21 674 1571 741 32 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 11 0 0 10 0 0 0 16 15 0 0 124 1 0 0] 50 5 176 5808 2352 18 #{UI.Splitter} 50 12 nil 32 50 2 8 1140850688 1 6256 nil nil nil 517 nil nil nil 3142 1 #{UI.DraggableViewInteractor} 6256 nil 1 #left nil nil nil 674 1 1 674 9 9 nil 6352 nil 578 50 1 626 #createAt:extent: 50 2 674 941 1 674 11 741 6256 770 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 8 #() 832 nil 27 4912 832 nil 27)! !
!Tools.DebugInfoPlugin class categoriesForMethods!
icon!constants!public! !
resource_Default_view!public!resources-views! !
!

