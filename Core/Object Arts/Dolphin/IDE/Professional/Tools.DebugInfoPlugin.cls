"Filed out from Dolphin Smalltalk"!

Tools.ClassBrowserPlugin subclass: #'Tools.DebugInfoPlugin'
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Tools.DebugInfoPlugin guid: (Core.GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!
Tools.DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!
!Tools.DebugInfoPlugin categoriesForClass!Browser-Plugins! !
!Tools.DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: SmalltalkSystem current workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: SmalltalkSystem current methodWorkspaceClass new name: 'source'.
	sourcePresenter isAutoParseEnabled: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	(self model)
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter 
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aPuttableStream
	"Append to the <puttableStream> first argument a String whose characters are a representation of the receiver that an end-user might want to see.
	This will be used as the label for the tab when the receiver is being displayed as a plugin within the Class Browser."

	aPuttableStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags | (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler
		compile: aCompiledMethod getSource
		in: methodClass
		environment: aCompiledMethod environment
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !
!Tools.DebugInfoPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!private! !
displayOn:!displaying!public! !
getDebugInfoFor:!private! !
onBrowserClassSelected!event handling!public! !
onBrowserMethodSelected!event handling!public! !
onTextMapEntrySelected!private! !
parseContext!public! !
selectedMethod!public! !
toggleDebug!public! !
!

!Tools.DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	Tools.ViewComposer openOn: (UI.ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 4 985166 10 ##(UI.STBViewProxy) ##(UI.ContainerView) 34 15 nil nil 34 2 8 1409286144 131073 416 nil nil nil 5 nil nil nil 416 1376774 ##(UI.ProportionalLayout) 170 176 34 8 410 ##(UI.ContainerView) 34 15 nil 416 34 2 8 1140850688 131073 544 nil nil nil 5 nil nil nil 544 984838 ##(UI.BorderLayout) 1 1 410 ##(UI.ContainerView) 34 15 nil 544 34 2 8 1140850688 131073 640 nil nil nil 5 nil nil nil 640 852806 1 ##(UI.FlowLayout) 1 1 1 170 192 34 4 410 ##(UI.CheckBox) 34 16 nil 640 34 2 8 1409363203 1 768 918598 2 ##(UI.ValueHolder) nil nil 1572870 ##(Kernel.NeverSearchPolicy) false nil nil 5 nil nil nil 768 nil 8 1812082816 1049094 ##(UI.NullConverter) nil nil nil 1310982 ##(Core.MessageSequence) 34 2 1049350 ##(Core.MessageSend) #createAt:extent: 34 2 918022 ##(Graphics.Point) 5 1 1042 131 51 768 994 #text: 34 1 8 'Debug?' 768 1179910 ##(OS.WINDOWPLACEMENT) 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 2 0 0 0 0 0 0 0 67 0 0 0 25 0 0 0] 8 #() 1042 193 193 nil 27 8 'debugToggle' 410 ##(UI.CheckBox) 34 16 nil 640 34 2 8 1409363203 1 1232 834 nil nil 880 false nil nil 5 nil nil nil 1232 nil 8 1812082816 914 nil nil nil 946 34 2 994 #createAt:extent: 34 2 1042 135 1 1042 171 51 1232 994 #text: 34 1 8 'Optimised?' 1232 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 67 0 0 0 0 0 0 0 152 0 0 0 25 0 0 0] 8 #() 1200 nil 27 8 'optimisedToggle' 1180166 ##(Graphics.Rectangle) 1042 5 1 1042 1 1 946 34 1 994 #createAt:extent: 34 2 1042 1 1 1042 317 51 640 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 34 2 768 1232 1200 nil 27 nil nil nil 410 ##(UI.ListView) 34 45 nil 544 34 2 8 1409388621 1 1760 787270 2 ##(UI.ListModel) 138 144 8 #() nil 1769478 ##(Kernel.IdentitySearchPolicy) 917510 ##(Graphics.Color) #default nil 5 nil nil nil 1760 nil 8 1812034736 786950 ##(Core.Message) #displayString 8 #() nil 1639750 1 ##(Graphics.IconImageManager) nil nil nil nil nil nil 138 144 34 2 1117254 5 ##(UI.ListViewColumn) 8 'IP' 87 #left 1970 #displayString 2000 1970 #<= 8 #() 1246566 3 ##(Kernel.BlockClosure) 0 nil 1639718 ##(Kernel.CompiledExpression) 2 1 ##(Core.UndefinedObject) 8 'doIt' 8 '[:each | each key]' 8 #[30 105 226 0 106] #key 2192 7 257 nil nil 1760 nil 1 nil nil 2082 8 'Range' 223 #left 1970 #displayString 8 #() 1970 #<= 2336 2178 0 nil 2210 1 83886081 ##(Core.UndefinedObject) 8 'doIt' 8 '[:each | each value]' 8 #[29 105 17 142 106] 2368 7 257 nil nil 1760 nil 3 nil nil #report 8 #() nil 131169 nil 1 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 946 34 2 994 #createAt:extent: 34 2 1042 1 51 1042 317 691 1760 994 #text: 34 1 8 'IP' 1760 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 8 #() 1200 nil 35 170 192 34 2 1760 8 'textMap' 1554 1042 1 1 1042 5 1 946 34 1 994 #createAt:extent: 34 2 1042 1 1 1042 321 741 544 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 34 2 640 1760 1200 nil 27 1 410 ##(UI.Scintilla.ScintillaView) 34 52 nil 416 34 2 8 1174475012 1 2896 834 nil false 1769478 ##(Kernel.EqualitySearchPolicy) nil 1922 #highlight3d nil 1045 nil nil nil 2896 nil 8 1615733816 914 nil nil 11 nil 170 192 34 10 #indentGuide 1444934 1 ##(UI.Scintilla.TextStyle) 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #whitespace 3090 3 nil nil 1 nil nil nil nil #whitespace nil nil nil #lineNumber 3090 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #normal 3090 1 nil nil 1 nil nil nil nil #normal nil nil nil #callTip 3090 77 1922 #gray 1922 #white 1 nil nil nil nil #callTip nil nil nil nil 1507654 1 ##(UI.Scintilla.NullStyler) #normal 170 192 34 2 #default 1903686 2 ##(UI.Scintilla.MarkerDefinition) 1 nil nil nil 2896 #circle nil nil nil nil nil nil 138 ##(Core.IdentitySet) 1872 nil 170 176 1872 9215 nil nil 170 176 34 2 81 1922 #windowText nil nil 2162950 ##(UI.Scintilla.NullScintillaLibrary) nil 65 nil nil nil 8 '' 1 170 192 34 2 #container 3056 nil nil nil nil 208 nil 170 192 1872 nil nil 170 192 34 6 #Error 3090 1031 1922 #firebrick 1922 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 3090 1029 nil 1922 #gainsboro 1 nil nil nil nil #Notification nil nil nil #Warning 3090 1027 1922 #darkGoldenrod 1922 #ivory 1 nil nil nil nil #Warning nil nil nil nil nil nil 946 34 8 994 #createAt:extent: 34 2 1042 951 1 1042 621 741 2896 994 #wordWrap: 8 #(true) 2896 994 #margins: 34 1 34 3 1247302 3 ##(UI.Scintilla.Margin) 1 2896 1 3 nil nil nil nil 3826 3 2896 1 nil nil 67108863 nil nil 3826 5 2896 1 nil nil nil nil nil 2896 994 #canHScroll: 8 #(false) 2896 994 #maxCompletionListHeight: 8 #(9) 2896 994 #sciSetTechnology: 8 #(1) 2896 994 #sciSetFontQuality: 8 #(3) 2896 994 #sciSetSelectionLayer: 8 #(1) 2896 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 8 #() 1200 nil 35 9 410 ##(UI.Scintilla.ScintillaView) 34 52 nil 416 34 2 8 1445007684 1 4096 nil 1936 nil 21 461638 4 ##(UI.Menu) nil true 34 9 4162 nil true 34 3 1180742 2 ##(UI.CommandMenuItem) 1 1377606 4 ##(UI.CommandDescription) #copySelection 8 '&Copy' 1 1 852806 4 ##(Graphics.Icon) nil true 2819078 ##(Graphics.ImageFromStringResourceInitializer) 8 'EditCopy.ico' 2490894 ##(Kernel.STBExternalResourceLibraryProxy) 8 'dolphindr8.dll' nil 65541 nil nil nil 1179974 1 ##(UI.DividerMenuItem) 4097 4242 1 4274 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 4162 nil true 34 6 4242 1 4274 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 4242 1 4274 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 4242 1 4274 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 4242 1 4274 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 4242 1 4274 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 4242 1 4274 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 4450 4097 4242 1 4274 #browseIt 8 'Bro&wse It' 1 1 4322 nil true 4354 8 'ClassBrowserShell.ico' 4416 65541 nil nil nil 4242 1 4274 #evaluateIt 8 'E&valuate It' 1 1 4322 nil true 4354 8 'EvaluateIt.ico' 4416 65541 nil nil nil 4242 1 4274 #inspectIt 8 '&Inspect It' 1 1 4322 nil true 4354 8 'InspectIt.ico' 4416 65541 nil nil nil 4242 1 4274 #debugIt 8 'Deb&ug It' 1 1 4322 nil true 4354 8 'Debugger.ico' 4416 65541 nil nil nil 4450 4097 4162 nil true 34 4 4242 2097153 4274 #browseDefinitions 8 'Defi&nitions of <1d>' 1 1 nil nil nil 4242 1 4274 #browseReferences 8 '&References to <1d>' 1 1 nil nil nil 4450 4097 4242 1 4274 #browseMessage 8 '<1d>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 4096 nil 8 1615733816 914 nil nil 11 nil 170 192 34 4 #callTip 3090 77 3184 3200 1 nil nil nil nil #callTip nil nil nil #normal 3090 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1770758 ##(Tools.SmalltalkMethodStyler) 1 nil nil false 138 144 1872 170 192 34 2 #default 3282 1 nil nil nil 4096 #circle nil nil nil nil nil nil 138 ##(Core.IdentitySet) 1872 nil 170 176 1872 9215 nil nil 170 176 34 2 81 3376 nil nil 3408 nil 65 nil nil 170 192 34 6 #literalArray 8 '()' #literalBytes 8 '[]' #specialCharacter 8 '()[]<>' 8 '' 3 170 192 34 2 #container 5552 nil nil nil nil 208 nil 170 192 34 4 #Error 1772614 4 ##(UI.Scintilla.IndicatorStyle) 19 4096 1922 #red 3 3 #Error nil nil nil nil nil nil #Warning 5938 17 4096 1922 #blue 3 3 #Warning nil nil nil nil nil nil nil nil 170 192 34 6 #Error 3090 1031 3536 3552 1 nil nil nil nil #Error nil nil nil #Notification 3090 1029 nil 3584 1 nil nil nil nil #Notification nil nil nil #Warning 3090 1027 3616 3632 1 nil nil nil nil #Warning nil nil nil nil nil nil 946 34 10 994 #createAt:extent: 34 2 1042 323 1 1042 619 741 4096 994 #contextMenu: 34 1 4176 4096 994 #sciSetMouseDwellTime: 8 #(500) 4096 994 #wordWrap: 8 #(true) 4096 994 #margins: 34 1 34 3 3826 1 4096 33 3 nil nil nil nil 3826 3 4096 1 nil nil 67108863 nil nil 3826 5 4096 1 nil nil nil nil nil 4096 994 #backspaceUnindents: 8 #(true) 4096 994 #maxCompletionListHeight: 8 #(9) 4096 994 #sciSetTechnology: 8 #(1) 4096 994 #sciSetFontQuality: 8 #(3) 4096 994 #sciSetSelectionLayer: 8 #(1) 4096 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 8 #() 1200 nil 35 9 410 ##(UI.StaticRectangle) 34 14 nil 416 34 2 8 1140850952 1 6592 nil 1936 nil 5 nil nil nil 6592 nil 8 1812122528 946 34 2 994 #createAt:extent: 34 2 1042 321 1 1042 3 741 6592 994 #isEnabled: 8 #(false) 6592 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 8 #() 1200 nil 27 1 false 170 192 34 4 4096 8 'source' 2896 8 'disassembly' nil 946 34 1 994 #createAt:extent: 34 2 1042 12287 21 1042 1571 741 416 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 23 0 0 10 0 0 0 16 27 0 0 124 1 0 0] 34 5 544 6592 4096 410 ##(UI.Splitter) 34 12 nil 416 34 2 8 1140850688 1 7056 nil nil nil 517 nil nil nil 1707078 1 ##(UI.DraggableViewInteractor) 7056 nil 1 #left nil nil nil 1042 1 1 1042 9 9 nil 7152 nil 946 34 1 994 #createAt:extent: 34 2 1042 941 1 1042 11 741 7056 1138 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 8 #() 1200 nil 27 2896 1200 nil 27 )! !
!Tools.DebugInfoPlugin class categoriesForMethods!
icon!constants!public! !
resource_Default_view!public!resources-views! !
!

