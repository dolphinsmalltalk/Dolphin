"Filed out from Dolphin Smalltalk"!

Tools.ClassBrowserPlugin
	subclass: #'Tools.DebugInfoPlugin'
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Tools.DebugInfoPlugin guid: (Core.GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!
Tools.DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!
!Tools.DebugInfoPlugin categoriesForClass!Browser-Plugins! !
!Tools.DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: SmalltalkSystem current workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: SmalltalkSystem current methodWorkspaceClass new name: 'source'.
	sourcePresenter
		isAutoParseEnabled: false;
		isSelectionMatched: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	self model
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	method selector: method selector asSymbol.
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aPuttableStream
	"Append to the <puttableStream> first argument a String whose characters are a representation of the receiver that an end-user might want to see.
	This will be used as the label for the tab when the receiver is being displayed as a plugin within the Class Browser."

	aPuttableStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags | (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler
		compileForMethod: aCompiledMethod getSource
		in: methodClass
		environment: aCompiledMethod environment
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !
!Tools.DebugInfoPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!private! !
displayOn:!displaying!public! !
getDebugInfoFor:!private! !
onBrowserClassSelected!event handling!public! !
onBrowserMethodSelected!event handling!public! !
onTextMapEntrySelected!private! !
parseContext!public! !
selectedMethod!public! !
toggleDebug!public! !
!

!Tools.DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	Tools.ViewComposer openOn: (UI.ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 6 2118 10 #{UI.STBViewProxy} #{UI.ContainerView} 38 #{Core.Array} 15 nil nil 50 2 8 1409286144 131073 32 nil nil nil 5 nil nil nil 32 518 #{UI.ProportionalLayout} 518 #{Kernel.STBCollectionProxy} #{Core.LookupTable} 50 4 518 #{Core.Association} 18 #{UI.ContainerView} 50 15 nil 32 50 2 8 1140850688 131073 224 nil nil nil 5 nil nil nil 224 1798 #{UI.BorderLayout} 1 1 18 #{UI.ContainerView} 50 15 nil 224 50 2 8 1140850688 131073 320 nil nil nil 517 nil nil nil 320 838 1 #{UI.FlowLayout} 11 1 1 518 #{Kernel.STBIdentityDictionaryProxy} #{Core.IdentityDictionary} 50 4 18 #{UI.CheckBox} 50 16 nil 320 50 2 8 1409363203 1 464 1094 2 #{UI.ValueHolder} nil nil 6 #{Kernel.NeverSearchPolicy} false nil nil 517 nil nil nil 464 nil nil 518 #{UI.NullConverter} nil nil nil 262 #{Core.MessageSequence} 50 2 774 #{Core.MessageSend} #createAt:extent: 50 2 518 #{Graphics.Point} 5 7 722 127 39 464 674 #text: 50 1 8 'Debug?' 464 262 #{OS.WINDOWPLACEMENT} 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 2 0 0 0 3 0 0 0 65 0 0 0 22 0 0 0] 8 #() 722 193 193 nil 27 8 'debugToggle' 18 #{UI.CheckBox} 50 16 nil 320 50 2 8 1409363203 1 912 530 nil nil 576 false nil nil 517 nil nil nil 912 nil nil 594 nil nil nil 626 50 2 674 #createAt:extent: 50 2 722 141 7 722 169 39 912 674 #text: 50 1 8 'Optimised?' 912 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 70 0 0 0 3 0 0 0 154 0 0 0 22 0 0 0] 8 #() 880 nil 27 8 'optimisedToggle' 518 #{Graphics.Rectangle} 722 5 7 722 1 7 626 50 1 674 #createAt:extent: 50 2 722 1 1 722 317 51 320 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 50 2 464 912 880 nil 27 nil nil nil 18 #{UI.ListView} 50 45 nil 224 50 2 8 1409388621 1 1424 838 2 #{UI.ListModel} 550 #{Core.OrderedCollection} 0 nil 6 #{Kernel.IdentitySearchPolicy} 6 #{Graphics.Color} #default nil 5 nil nil nil 1424 nil nil 518 #{Core.Message} #displayString 8 #() nil 1350 1 #{Graphics.IconImageManager} nil nil nil nil nil nil 1522 2 3142 5 #{UI.ListViewColumn} 8 'IP' 87 #left 1618 #displayString 1648 1618 #<= 8 #() 1618 #key 8 #() nil 1424 nil 1 nil nil 1714 8 'Range' 231 #left 1618 #displayString 8 #() 1618 #<= 1888 1618 #value 1824 nil 1424 nil 3 nil nil #report 8 #() nil 131169 nil 1 nil nil nil nil 1 nil nil nil nil nil nil nil nil nil nil 626 50 2 674 #createAt:extent: 50 2 722 1 51 722 317 691 1424 674 #text: 50 1 8 'IP' 1424 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 8 #() 880 nil 35 418 #{Core.IdentityDictionary} 50 2 1424 8 'textMap' 1218 722 1 1 722 5 1 626 50 1 674 #createAt:extent: 50 2 722 1 1 722 321 741 224 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 50 2 320 1424 880 nil 27 1 194 18 #{UI.StaticRectangle} 50 14 nil 32 50 2 8 1140850952 1 2400 nil 1600 nil 5 nil nil nil 2400 nil nil 626 50 2 674 #createAt:extent: 50 2 722 321 1 722 3 741 2400 674 #isEnabled: 8 #(false) 2400 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 8 #() 880 nil 27 1 194 18 #{UI.Scintilla.ScintillaView} 50 56 nil 32 50 2 8 1445007684 1 2656 nil 1600 nil 21 2886 4 #{UI.Menu} nil true 50 9 2722 nil true 50 3 1094 2 #{UI.CommandMenuItem} 1 1350 4 #{UI.CommandDescription} #copySelection 8 '&Copy' 1 1 838 4 #{Graphics.Icon} nil true 1030 #{Graphics.ImageFromStringResourceInitializer} 8 'EditCopy.ico' 838 1 #{External.ResourceLibrary} 8 'dolphindr8.dll' 65541 nil nil nil 326 1 #{UI.DividerMenuItem} 4097 2802 1 2834 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 2722 nil true 50 6 2802 1 2834 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 2802 1 2834 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 2802 1 2834 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 2802 1 2834 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 2802 1 2834 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 2802 1 2834 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 3010 4097 2802 1 2834 #browseIt 8 'Bro&wse It' 1 1 2882 nil true 2914 8 'ClassBrowserShell.ico' 2976 65541 nil nil nil 2802 1 2834 #evaluateIt 8 'E&valuate It' 1 1 2882 nil true 2914 8 'EvaluateIt.ico' 2976 65541 nil nil nil 2802 1 2834 #inspectIt 8 '&Inspect It' 1 1 2882 nil true 2914 8 'InspectIt.ico' 2976 65541 nil nil nil 2802 1 2834 #debugIt 8 'Deb&ug It' 1 1 2882 nil true 2914 8 'Debugger.ico' 2976 65541 nil nil nil 3010 4097 2722 nil true 50 4 2802 2097153 2834 #browseDefinitions 8 'Defi&nitions of <d:…>' 1 1 nil nil nil 2802 1 2834 #browseReferences 8 '&References to <d:…>' 1 1 nil nil nil 3010 4097 2802 1 2834 #browseMessage 8 '<d:Message>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 2656 nil nil 594 nil nil 11 #focusLost nil nil nil nil 550 #{Core.IdentityDictionary} 2 #callTip 3142 1 #{UI.Scintilla.TextStyle} 77 1586 #gray 1586 #white 1 nil nil nil nil #callTip nil nil nil #normal 4130 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1286 #{Tools.SmalltalkMethodStyler} 1 nil nil false 1522 0 4098 1 #default 3142 2 #{UI.Scintilla.MarkerDefinition} 1 nil nil nil 2656 #circle nil nil nil nil nil nil 294 #{Core.IdentitySet} 0 nil 550 #{Core.LookupTable} 0 9215 nil nil 4338 1 81 1586 #windowText nil nil 262 #{UI.Scintilla.NullScintillaLibrary} nil 65 nil nil 4098 3 #literalArray 8 '()' #literalBytes 8 '[]' #specialCharacter 8 '()[]<>' nil 3 4098 1 #container 4112 nil nil nil nil #{Core.Utf8String} nil 4098 2 #Error 3142 5 #{UI.Scintilla.IndicatorDefinition} 19 2656 1586 #red 3 3 #Error nil nil nil nil nil nil #Warning 4530 17 2656 1586 #blue 3 3 #Warning nil nil nil nil nil nil nil nil 4098 3 #Error 4130 1031 1586 #firebrick 1586 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 4130 1029 nil 1586 #gainsboro 1 nil nil nil nil #Notification nil nil nil #Warning 4130 1027 1586 #darkGoldenrod 1586 #ivory 1 nil nil nil nil #Warning nil nil nil nil nil nil 626 50 9 674 #createAt:extent: 50 2 722 323 1 722 619 741 2656 674 #sciSetMouseDwellTime: 8 #(500) 2656 674 #wordWrap: 8 #(true) 2656 674 #margins: 50 1 50 3 2118 3 #{UI.Scintilla.Margin} 1 2656 33 3 nil nil nil nil 4962 3 2656 nil nil nil 67108863 nil nil 4962 5 2656 nil nil nil nil nil nil 2656 674 #backspaceUnindents: 8 #(true) 2656 674 #maxCompletionListHeight: 8 #(9) 2656 674 #sciSetTechnology: 8 #(1) 2656 674 #sciSetFontQuality: 8 #(3) 2656 674 #sciSetSelectionLayer: 8 #(1) 2656 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 8 #() 880 nil 45 9 194 18 #{UI.Scintilla.ScintillaView} 50 56 nil 32 50 2 8 1174475012 1 5248 530 nil false 6 #{Kernel.EqualitySearchPolicy} nil 1586 #highlight3d nil 1045 nil nil nil 5248 nil nil 594 nil nil 11 #focusLost nil nil nil nil 4098 5 #callTip 4130 77 4160 4176 1 nil nil nil nil #callTip nil nil nil #indentGuide 4130 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #lineNumber 4130 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #normal 4130 1 nil nil 1 nil nil nil nil #normal nil nil nil #whitespace 4130 3 nil nil 1 nil nil nil nil #whitespace nil nil nil nil 326 1 #{UI.Scintilla.NullStyler} #normal 4098 1 #default 4274 1 nil nil nil 5248 #circle nil nil nil nil nil nil 4306 0 nil 4338 0 9215 nil nil 4338 1 81 4384 nil nil 4416 nil 65 nil nil nil nil 1 4098 1 #container 5392 nil nil nil nil #{Core.Utf8String} nil 4098 0 nil nil 4098 3 #Error 4130 1031 4640 4656 1 nil nil nil nil #Error nil nil nil #Notification 4130 1029 nil 4688 1 nil nil nil nil #Notification nil nil nil #Warning 4130 1027 4720 4736 1 nil nil nil nil #Warning nil nil nil nil nil nil 626 50 8 674 #createAt:extent: 50 2 722 951 1 722 621 741 5248 674 #wordWrap: 8 #(true) 5248 674 #margins: 50 1 50 3 4962 1 5248 nil 3 nil nil nil nil 4962 3 5248 nil nil nil 67108863 nil nil 4962 5 5248 nil nil nil nil nil nil 5248 674 #sciSetHScrollBar: 8 #(false) 5248 674 #maxCompletionListHeight: 8 #(9) 5248 674 #sciSetTechnology: 8 #(1) 5248 674 #sciSetFontQuality: 8 #(3) 5248 674 #sciSetSelectionLayer: 8 #(1) 5248 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 8 #() 880 nil 45 9 false 418 4096 50 4 5248 8 'disassembly' 2656 8 'source' nil 626 50 1 674 #createAt:extent: 50 2 722 6143 21 722 1571 741 32 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 11 0 0 10 0 0 0 16 15 0 0 124 1 0 0] 50 5 224 2400 2656 18 #{UI.Splitter} 50 12 nil 32 50 2 8 1140850688 1 6336 nil nil nil 517 nil nil nil 3142 1 #{UI.DraggableViewInteractor} 6336 nil 1 #left nil nil nil 722 1 1 722 9 9 nil 6432 nil 626 50 1 674 #createAt:extent: 50 2 722 941 1 722 11 741 6336 818 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 8 #() 880 nil 27 5248 880 nil 27)! !
!Tools.DebugInfoPlugin class categoriesForMethods!
icon!constants!public! !
resource_Default_view!public!resources-views! !
!

