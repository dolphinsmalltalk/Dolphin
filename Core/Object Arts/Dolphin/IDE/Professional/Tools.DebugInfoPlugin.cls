"Filed out from Dolphin Smalltalk"!

Tools.ClassBrowserPlugin
	subclass: #'Tools.DebugInfoPlugin'
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Tools.DebugInfoPlugin guid: (Core.GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!
Tools.DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!
!Tools.DebugInfoPlugin categoriesForClass!Browser-Plugins! !
!Tools.DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: SmalltalkSystem current workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: SmalltalkSystem current methodWorkspaceClass new name: 'source'.
	sourcePresenter
		isAutoParseEnabled: false;
		isSelectionMatched: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	self model
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	method selector: method selector asSymbol.
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aPuttableStream
	"Append to the <puttableStream> first argument a String whose characters are a representation of the receiver that an end-user might want to see.
	This will be used as the label for the tab when the receiver is being displayed as a plugin within the Class Browser."

	aPuttableStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags | (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler
		compile: aCompiledMethod getSource
		in: methodClass
		environment: aCompiledMethod environment
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !
!Tools.DebugInfoPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!private! !
displayOn:!displaying!public! !
getDebugInfoFor:!private! !
onBrowserClassSelected!event handling!public! !
onBrowserMethodSelected!event handling!public! !
onTextMapEntrySelected!private! !
parseContext!public! !
selectedMethod!public! !
toggleDebug!public! !
!

!Tools.DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	Tools.ViewComposer openOn: (UI.ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 5 985166 10 #{UI.STBViewProxy} #{UI.ContainerView} 34 15 nil nil 34 2 8 1409286144 131073 416 nil nil nil 5 nil nil nil 416 1376774 #{UI.ProportionalLayout} 170 176 34 8 410 #{UI.Scintilla.ScintillaView} 34 52 nil 416 34 2 8 1445007684 1 544 nil 917510 #{Graphics.Color} #default nil 21 461638 4 #{UI.Menu} nil true 34 9 642 nil true 34 3 1180742 2 #{UI.CommandMenuItem} 1 1377606 4 #{UI.CommandDescription} #copySelection 8 '&Copy' 1 1 852806 4 #{Graphics.Icon} nil true 2819078 #{Graphics.ImageFromStringResourceInitializer} 8 'EditCopy.ico' 2490894 #{Kernel.STBExternalResourceLibraryProxy} 8 'dolphindr8.dll' nil 65541 nil nil nil 1179974 1 #{UI.DividerMenuItem} 4097 722 1 754 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 642 nil true 34 6 722 1 754 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 722 1 754 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 722 1 754 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 722 1 754 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 722 1 754 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 722 1 754 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 930 4097 722 1 754 #browseIt 8 'Bro&wse It' 1 1 802 nil true 834 8 'ClassBrowserShell.ico' 896 65541 nil nil nil 722 1 754 #evaluateIt 8 'E&valuate It' 1 1 802 nil true 834 8 'EvaluateIt.ico' 896 65541 nil nil nil 722 1 754 #inspectIt 8 '&Inspect It' 1 1 802 nil true 834 8 'InspectIt.ico' 896 65541 nil nil nil 722 1 754 #debugIt 8 'Deb&ug It' 1 1 802 nil true 834 8 'Debugger.ico' 896 65541 nil nil nil 930 4097 642 nil true 34 4 722 2097153 754 #browseDefinitions 8 'Defi&nitions of <1d>' 1 1 nil nil nil 722 1 754 #browseReferences 8 '&References to <1d>' 1 1 nil nil nil 930 4097 722 1 754 #browseMessage 8 '<1d>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 544 nil 8 1829345744 1049094 #{UI.NullConverter} nil nil 11 nil 170 192 34 4 #callTip 1444934 1 #{UI.Scintilla.TextStyle} 77 610 #gray 610 #white 1 nil nil nil nil #callTip nil nil nil #normal 2082 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1770758 #{Tools.SmalltalkMethodStyler} 1 nil nil false 138 144 8 #() 170 192 34 2 #default 1903686 2 #{UI.Scintilla.MarkerDefinition} 1 nil nil nil 544 #circle nil nil nil nil nil nil 138 #{Core.IdentitySet} 2208 nil 170 176 2208 9215 nil nil 170 176 34 2 81 610 #windowText nil nil 2162950 #{UI.Scintilla.NullScintillaLibrary} nil 65 nil nil 170 192 34 6 #specialCharacter 8 '()[]<>' #literalArray 8 '()' #literalBytes 8 '[]' nil 3 170 192 34 2 #container 2048 nil nil nil nil 208 nil 170 192 34 4 #Error 1772614 4 #{UI.Scintilla.IndicatorDefinition} 19 544 610 #red 3 3 #Error nil nil nil nil nil nil #Warning 2546 17 544 610 #blue 3 3 #Warning nil nil nil nil nil nil nil nil 170 192 34 6 #Notification 2082 1029 nil 610 #gainsboro 1 nil nil nil nil #Notification nil nil nil #Warning 2082 1027 610 #darkGoldenrod 610 #ivory 1 nil nil nil nil #Warning nil nil nil #Error 2082 1031 610 #firebrick 610 #floralWhite 1 nil nil nil nil #Error nil nil nil nil nil nil 1310982 #{Core.MessageSequence} 34 9 1049350 #{Core.MessageSend} #createAt:extent: 34 2 918022 #{Graphics.Point} 323 1 2882 619 741 544 2834 #sciSetMouseDwellTime: 8 #(500) 544 2834 #wordWrap: 8 #(true) 544 2834 #margins: 34 1 34 3 1247302 3 #{UI.Scintilla.Margin} 1 544 33 3 nil nil nil nil 3042 3 544 1 nil nil 67108863 nil nil 3042 5 544 1 nil nil nil nil nil 544 2834 #backspaceUnindents: 8 #(true) 544 2834 #maxCompletionListHeight: 8 #(9) 544 2834 #sciSetTechnology: 8 #(1) 544 2834 #sciSetFontQuality: 8 #(3) 544 2834 #sciSetSelectionLayer: 8 #(1) 544 1179910 #{OS.WINDOWPLACEMENT} 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 8 #() 2882 193 193 nil 37 9 410 #{UI.ContainerView} 34 15 nil 416 34 2 8 1140850688 131073 3344 nil nil nil 5 nil nil nil 3344 984838 #{UI.BorderLayout} 1 1 410 #{UI.ContainerView} 34 15 nil 3344 34 2 8 1140850688 131073 3440 nil nil nil 517 nil nil nil 3440 852806 1 #{UI.FlowLayout} 11 1 1 170 192 34 4 410 #{UI.CheckBox} 34 16 nil 3440 34 2 8 1409363203 1 3568 918598 2 #{UI.ValueHolder} nil nil 1572870 #{Kernel.NeverSearchPolicy} false nil nil 517 nil nil nil 3568 nil 8 1819032944 2018 nil nil nil 2786 34 2 2834 #createAt:extent: 34 2 2882 5 7 2882 127 39 3568 2834 #text: 34 1 8 'Debug?' 3568 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 2 0 0 0 3 0 0 0 65 0 0 0 22 0 0 0] 8 #() 3328 nil 27 8 'debugToggle' 410 #{UI.CheckBox} 34 16 nil 3440 34 2 8 1409363203 1 3936 3634 nil nil 3680 false nil nil 517 nil nil nil 3936 nil 8 1819032944 2018 nil nil nil 2786 34 2 2834 #createAt:extent: 34 2 2882 141 7 2882 169 39 3936 2834 #text: 34 1 8 'Optimised?' 3936 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 70 0 0 0 3 0 0 0 154 0 0 0 22 0 0 0] 8 #() 3328 nil 27 8 'optimisedToggle' 1180166 #{Graphics.Rectangle} 2882 5 7 2882 1 7 2786 34 1 2834 #createAt:extent: 34 2 2882 1 1 2882 317 51 3440 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 34 2 3568 3936 3328 nil 27 nil nil nil 410 #{UI.ListView} 34 45 nil 3344 34 2 8 1409388621 1 4464 787270 2 #{UI.ListModel} 138 144 2208 nil 1769478 #{Kernel.IdentitySearchPolicy} 624 nil 5 nil nil nil 4464 nil 8 1819093264 786950 #{Core.Message} #displayString 8 #() nil 1639750 1 #{Graphics.IconImageManager} nil nil nil nil nil nil 138 144 34 2 1117254 5 #{UI.ListViewColumn} 8 'IP' 87 #left 4626 #displayString 4656 4626 #<= 8 #() 4626 #key 8 #() nil 4464 nil 1 nil nil 4738 8 'Range' 231 #left 4626 #displayString 8 #() 4626 #<= 4912 4626 #value 4848 nil 4464 nil 3 nil nil #report 8 #() nil 131169 nil 1 nil nil nil nil 1 nil nil nil nil nil nil nil nil nil nil 2786 34 2 2834 #createAt:extent: 34 2 2882 1 51 2882 317 691 4464 2834 #text: 34 1 8 'IP' 4464 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 8 #() 3328 nil 35 170 192 34 2 4464 8 'textMap' 4258 2882 1 1 2882 5 1 2786 34 1 2834 #createAt:extent: 34 2 2882 1 1 2882 321 741 3344 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 34 2 3440 4464 3328 nil 27 1 410 #{UI.StaticRectangle} 34 14 nil 416 34 2 8 1140850952 1 5408 nil 624 nil 5 nil nil nil 5408 nil 8 1819237552 2786 34 2 2834 #createAt:extent: 34 2 2882 321 1 2882 3 741 5408 2834 #isEnabled: 8 #(false) 5408 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 8 #() 3328 nil 27 1 410 #{UI.Scintilla.ScintillaView} 34 52 nil 416 34 2 8 1174475012 1 5664 3634 nil false 1769478 #{Kernel.EqualitySearchPolicy} nil 610 #highlight3d nil 1045 nil nil nil 5664 nil 8 1829345744 2018 nil nil 11 nil 170 192 34 10 #indentGuide 2082 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #lineNumber 2082 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #callTip 2082 77 2112 2128 1 nil nil nil nil #callTip nil nil nil #whitespace 2082 3 nil nil 1 nil nil nil nil #whitespace nil nil nil #normal 2082 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1507654 1 #{UI.Scintilla.NullStyler} #normal 170 192 34 2 #default 2258 1 nil nil nil 5664 #circle nil nil nil nil nil nil 138 #{Core.IdentitySet} 2208 nil 170 176 2208 9215 nil nil 170 176 34 2 81 2352 nil nil 2384 nil 65 nil nil nil nil 1 170 192 34 2 #container 5824 nil nil nil nil 208 nil 170 192 2208 nil nil 170 192 34 6 #Notification 2082 1029 nil 2672 1 nil nil nil nil #Notification nil nil nil #Warning 2082 1027 2704 2720 1 nil nil nil nil #Warning nil nil nil #Error 2082 1031 2752 2768 1 nil nil nil nil #Error nil nil nil nil nil nil 2786 34 8 2834 #createAt:extent: 34 2 2882 951 1 2882 621 741 5664 2834 #wordWrap: 8 #(true) 5664 2834 #margins: 34 1 34 3 3042 1 5664 1 3 nil nil nil nil 3042 3 5664 1 nil nil 67108863 nil nil 3042 5 5664 1 nil nil nil nil nil 5664 2834 #canHScroll: 8 #(false) 5664 2834 #maxCompletionListHeight: 8 #(9) 5664 2834 #sciSetTechnology: 8 #(1) 5664 2834 #sciSetFontQuality: 8 #(3) 5664 2834 #sciSetSelectionLayer: 8 #(1) 5664 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 8 #() 3328 nil 37 9 false 170 192 34 4 5664 8 'disassembly' 544 8 'source' nil 2786 34 1 2834 #createAt:extent: 34 2 2882 6143 21 2882 1571 741 416 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 11 0 0 10 0 0 0 16 15 0 0 124 1 0 0] 34 5 3344 5408 544 410 #{UI.Splitter} 34 12 nil 416 34 2 8 1140850688 1 6848 nil nil nil 517 nil nil nil 1707078 1 #{UI.DraggableViewInteractor} 6848 nil 1 #left nil nil nil 2882 1 1 2882 9 9 nil 6944 nil 2786 34 1 2834 #createAt:extent: 34 2 2882 941 1 2882 11 741 6848 3266 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 8 #() 3328 nil 27 5664 3328 nil 27)! !
!Tools.DebugInfoPlugin class categoriesForMethods!
icon!constants!public! !
resource_Default_view!public!resources-views! !
!

