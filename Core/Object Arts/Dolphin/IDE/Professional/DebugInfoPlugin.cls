"Filed out from Dolphin Smalltalk 7"!

ClassBrowserPlugin subclass: #DebugInfoPlugin
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	poolDictionaries: ''
	classInstanceVariableNames: ''!
DebugInfoPlugin guid: (GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!
DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!
!DebugInfoPlugin categoriesForClass!Browser-Plugins! !
!DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: Smalltalk developmentSystem workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: Smalltalk developmentSystem methodWorkspaceClass new name: 'source'.
	sourcePresenter isAutoParseEnabled: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	(self model)
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter 
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aStream
	"Append, to aStream, a String whose characters are a representation of the receiver as a user
	would want to see it. This will be used as the label for the tab when the receiver is being displayed
	as a plugin within the Class Browser"

	aStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod 
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags 
				| (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler 
		compile: aCompiledMethod getSource
		in: methodClass
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !
!DebugInfoPlugin categoriesFor: #clear!private! !
!DebugInfoPlugin categoriesFor: #createComponents!initializing!public! !
!DebugInfoPlugin categoriesFor: #createSchematicWiring!initializing!public! !
!DebugInfoPlugin categoriesFor: #displayMethod!private! !
!DebugInfoPlugin categoriesFor: #displayOn:!displaying!public! !
!DebugInfoPlugin categoriesFor: #getDebugInfoFor:!private! !
!DebugInfoPlugin categoriesFor: #onBrowserClassSelected!event handling!public! !
!DebugInfoPlugin categoriesFor: #onBrowserMethodSelected!event handling!public! !
!DebugInfoPlugin categoriesFor: #onTextMapEntrySelected!private! !
!DebugInfoPlugin categoriesFor: #parseContext!public! !
!DebugInfoPlugin categoriesFor: #selectedMethod!public! !
!DebugInfoPlugin categoriesFor: #toggleDebug!public! !

!DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	ViewComposer openOn: (ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 4 788558 10 ##(Smalltalk.STBViewProxy) ##(Smalltalk.ContainerView) 34 15 nil nil 34 2 8 1409286144 131073 416 nil nil nil 5 nil nil nil 416 1180166 ##(Smalltalk.ProportionalLayout) 170 176 34 8 410 ##(Smalltalk.StaticRectangle) 34 14 nil 416 34 2 8 1140850952 1 544 nil 327686 ##(Smalltalk.Color) #default nil 5 nil nil nil 544 nil 8 1889497552 983302 ##(Smalltalk.MessageSequence) 138 144 34 2 721670 ##(Smalltalk.MessageSend) #createAt:extent: 34 2 328198 ##(Smalltalk.Point) 321 1 770 3 741 544 722 #isEnabled: 8 #(false) 544 983302 ##(Smalltalk.WINDOWPLACEMENT) 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 8 #() 770 193 193 nil 27 1 410 ##(Smalltalk.ScintillaView) 34 50 nil 416 34 2 8 1445007684 1 928 nil 624 nil 21 265030 4 ##(Smalltalk.Menu) nil true 34 9 994 nil true 34 3 984134 2 ##(Smalltalk.CommandMenuItem) 1 1180998 4 ##(Smalltalk.CommandDescription) #copySelection 8 '&Copy' 1 1 263494 3 ##(Smalltalk.Icon) nil true 1572870 ##(Smalltalk.ImageRelativeFileLocator) 8 'EditCopy.ico' 2032142 ##(Smalltalk.STBExternalResourceLibraryProxy) 8 'dolphindr7.dll' nil nil nil 983366 1 ##(Smalltalk.DividerMenuItem) 4097 1074 1 1106 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 994 nil true 34 6 1074 1 1106 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 1074 1 1106 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 1074 1 1106 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 1074 1 1106 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 1074 1 1106 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 1074 1 1106 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 1282 4097 1074 1 1106 #browseIt 8 'Bro&wse It' 1 1 1154 nil true 1200 8 'ClassBrowserShell.ico' 1248 nil nil 1074 1 1106 #evaluateIt 8 'E&valuate It' 1 1 1154 nil true 1200 8 'EvaluateIt.ico' 1248 nil nil 1074 1 1106 #inspectIt 8 '&Inspect It' 1 1 1154 nil true 1200 8 'InspectIt.ico' 1248 nil nil 1074 1 1106 #debugIt 8 'Deb&ug It' 1 1 1154 nil true 1200 8 'Debugger.ico' 1248 nil nil 1282 4097 994 nil true 34 4 1074 2097153 1106 #browseDefinitions 8 'Defi&nitions of <1d>' 1 1 nil nil nil 1074 1 1106 #browseReferences 8 '&References to <1d>' 1 1 nil nil nil 1282 4097 1074 1 1106 #browseMessage 8 '<1d>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 928 nil 8 1393611199 852486 ##(Smalltalk.NullConverter) nil nil 11 nil 170 192 34 4 #callTip 1182790 1 ##(Smalltalk.ScintillaTextStyle) 77 610 #gray 610 #white 1 nil nil nil nil #callTip nil nil nil #normal 2370 1 nil nil 1 nil nil nil nil #normal nil nil nil 34 256 2432 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 2384 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 1377542 ##(Smalltalk.SmalltalkMethodStyler) 1 nil nil false 138 144 8 #() 170 192 34 2 #default 1641542 2 ##(Smalltalk.ScintillaMarkerDefinition) 1 nil nil nil 928 #circle nil nil nil nil nil nil 138 ##(Smalltalk.IdentitySet) 2512 nil 170 176 2512 9215 nil nil nil nil 610 #silver nil nil 65 nil nil 170 192 34 6 #literalArray 8 '()' #literalBytes 8 '[]' #specialCharacter 8 '()[]<>' 8 '' 3 170 192 34 2 #container 2336 nil nil nil nil 130003 nil 170 192 34 4 #Warning 1510470 3 ##(Smalltalk.ScintillaIndicatorStyle) 17 928 610 #blue 3 false #Warning nil nil nil nil nil nil #Error 2802 19 928 610 #red 3 false #Error nil nil nil nil nil nil nil nil 170 192 34 6 #Warning 2370 1027 610 #darkGoldenrod 610 #ivory 1 nil nil nil nil #Warning nil nil nil #Error 2370 1031 610 #firebrick 610 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 2370 1029 nil 610 #gainsboro 1 nil nil nil nil #Notification nil nil nil nil 658 138 144 34 10 722 #createAt:extent: 34 2 770 323 1 770 619 741 928 722 #contextMenu: 34 1 1008 928 722 #textLimit: 8 #(1073741823) 928 722 #hoverTime: 8 #(500) 928 722 #caretPeriod: 8 #(530) 928 722 #wordWrap: 8 #(true) 928 722 #margins: 34 1 34 3 985158 3 ##(Smalltalk.ScintillaMargin) 1 928 33 3 nil nil nil nil 3362 3 928 1 nil nil 67108863 nil nil 3362 5 928 1 nil nil nil nil nil 928 722 #backspaceUnindents: 8 #(true) 928 722 #maxCompletionListHeight: 8 #(9) 928 722 #edgeColumn: 8 #(1) 928 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 8 #() 912 nil 29 9 410 ##(Smalltalk.ContainerView) 34 15 nil 416 34 2 8 1140850688 131073 3568 nil nil nil 5 nil nil nil 3568 788230 ##(Smalltalk.BorderLayout) 1 1 410 ##(Smalltalk.ContainerView) 34 15 nil 3568 34 2 8 1140850688 131073 3664 nil nil nil 5 nil nil nil 3664 656198 1 ##(Smalltalk.FlowLayout) 1 1 1 170 192 34 4 410 ##(Smalltalk.CheckBox) 34 16 nil 3664 34 2 8 1409363203 1 3792 721990 2 ##(Smalltalk.ValueHolder) nil nil 1114118 ##(Smalltalk.NeverSearchPolicy) false nil nil 5 nil nil nil 3792 nil 8 1889532656 2306 nil nil nil 658 138 144 34 2 722 #createAt:extent: 34 2 770 5 1 770 131 51 3792 722 #text: 34 1 8 'Debug?' 3792 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 2 0 0 0 0 0 0 0 67 0 0 0 25 0 0 0] 8 #() 912 nil 27 8 'debugToggle' 410 ##(Smalltalk.CheckBox) 34 16 nil 3664 34 2 8 1409363203 1 4176 3858 nil nil 3904 false nil nil 5 nil nil nil 4176 nil 8 1889532656 2306 nil nil nil 658 138 144 34 2 722 #createAt:extent: 34 2 770 135 1 770 171 51 4176 722 #text: 34 1 8 'Optimised?' 4176 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 67 0 0 0 0 0 0 0 152 0 0 0 25 0 0 0] 8 #() 912 nil 27 8 'optimisedToggle' 590342 ##(Smalltalk.Rectangle) 770 5 1 770 1 1 658 138 144 34 1 722 #createAt:extent: 34 2 770 1 1 770 317 51 3664 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 34 2 3792 4176 912 nil 27 nil nil nil 410 ##(Smalltalk.ListView) 34 30 nil 3568 34 2 8 1409388621 1 4736 590662 2 ##(Smalltalk.ListModel) 138 144 2512 nil 1310726 ##(Smalltalk.IdentitySearchPolicy) 624 nil 5 nil nil nil 4736 nil 8 1889552144 459270 ##(Smalltalk.Message) #displayString 8 #() nil 1049926 1 ##(Smalltalk.IconImageManager) nil nil nil nil nil nil 138 144 34 2 920646 5 ##(Smalltalk.ListViewColumn) 8 'IP' 87 #left 4898 #displayString 4928 4898 #<= 8 #() 787814 3 ##(Smalltalk.BlockClosure) 0 nil 1180966 ##(Smalltalk.CompiledExpression) 2 1 ##(Smalltalk.UndefinedObject) 8 'doIt' 8 '[:each | each key]' 8 #[30 105 226 0 106] #key 5120 7 257 nil nil 4736 nil 1 nil nil 5010 8 'Range' 223 #left 4898 #displayString 8 #() 4898 #<= 5264 5106 0 nil 5138 1 83886081 ##(Smalltalk.UndefinedObject) 8 'doIt' 8 '[:each | each value]' 8 #[29 105 17 142 106] 5296 7 257 nil nil 4736 nil 3 nil nil #report 2512 nil 131169 nil 34 4 nil nil 770 1 1 nil 658 138 144 34 2 722 #createAt:extent: 34 2 770 1 51 770 317 691 4736 722 #text: 34 1 8 'IP' 4736 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 8 #() 912 nil 27 170 192 34 2 4736 8 'textMap' 4514 770 1 1 770 5 1 658 138 144 34 1 722 #createAt:extent: 34 2 770 1 1 770 321 741 3568 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 34 2 3664 4736 912 nil 27 1 410 ##(Smalltalk.ScintillaView) 34 50 nil 416 34 2 8 1174475012 1 5872 3858 nil false 1310726 ##(Smalltalk.EqualitySearchPolicy) nil 610 #highlight3d nil 1045 nil nil nil 5872 nil 8 1393611199 2306 nil nil 11 nil 170 192 34 10 #lineNumber 2370 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #callTip 2370 77 2400 2416 1 nil nil nil nil #callTip nil nil nil #whitespace 2370 3 nil nil 1 nil nil nil nil #whitespace nil nil nil #indentGuide 2370 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #normal 2370 1 nil nil 1 nil nil nil nil #normal nil nil nil 34 256 6128 6096 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 6064 nil nil nil 6112 6080 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 1245510 1 ##(Smalltalk.NullScintillaStyler) #normal 170 192 34 2 #default 2562 1 nil nil nil 5872 #circle nil nil nil nil nil nil 138 ##(Smalltalk.IdentitySet) 2512 nil 170 176 2512 9215 nil nil nil nil 2624 nil nil 65 nil nil nil 8 '' 1 170 192 34 2 #container 6032 nil nil nil nil 130003 nil 170 192 2512 nil nil 170 192 34 6 #Warning 2370 1027 2928 2944 1 nil nil nil nil #Warning nil nil nil #Error 2370 1031 2976 2992 1 nil nil nil nil #Error nil nil nil #Notification 2370 1029 nil 3024 1 nil nil nil nil #Notification nil nil nil nil 658 138 144 34 8 722 #createAt:extent: 34 2 770 951 1 770 621 741 5872 722 #textLimit: 8 #(1073741823) 5872 722 #caretPeriod: 8 #(530) 5872 722 #wordWrap: 8 #(true) 5872 722 #margins: 34 1 34 3 3362 1 5872 1 3 nil nil nil nil 3362 3 5872 1 nil nil 67108863 nil nil 3362 5 5872 1 nil nil nil nil nil 5872 722 #canHScroll: 8 #(false) 5872 722 #maxCompletionListHeight: 8 #(9) 5872 722 #edgeColumn: 8 #(1) 5872 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 8 #() 912 nil 29 9 false 170 192 34 4 928 8 'source' 5872 8 'disassembly' nil 658 138 144 34 1 722 #createAt:extent: 34 2 770 3839 21 770 1571 741 416 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 127 7 0 0 10 0 0 0 144 10 0 0 124 1 0 0] 34 5 3568 544 928 410 ##(Smalltalk.Splitter) 34 12 nil 416 34 2 8 1140850688 1 7088 nil nil nil 517 nil nil nil 1510470 1 ##(Smalltalk.DraggableViewInteractor) 7088 nil 1 #left nil nil nil 770 1 1 770 9 9 nil 7184 nil 658 138 144 34 1 722 #createAt:extent: 34 2 770 941 1 770 11 741 7088 850 8 #[44 0 0 0 0 0 0 0 1 0 0 0 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 255 214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 8 #() 912 nil 27 5872 912 nil 27 )! !
!DebugInfoPlugin class categoriesFor: #icon!constants!public! !
!DebugInfoPlugin class categoriesFor: #resource_Default_view!public!resources-views! !

