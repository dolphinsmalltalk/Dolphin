"Filed out from Dolphin Smalltalk"!

ClassBrowserPlugin subclass: #DebugInfoPlugin
	instanceVariableNames: 'disassemblyPresenter sourcePresenter textMapPresenter toggleDebugPresenter toggleOptimisedPresenter method'
	classVariableNames: ''
	poolDictionaries: ''
	classInstanceVariableNames: ''!

DebugInfoPlugin guid: (GUID fromString: '{d76ccba1-7398-4191-9068-fb4bcb1afb88}')!

DebugInfoPlugin comment: '`DebugInfoPlugin` is a `<classBrowserPlugin>` that shows a debug view of the currently selected method. It has 3 panes:
 - The left pane is the text map built by the compiler and used by the debugger to relate instruction pointer positions to the corresponding expression in the source text.
 - The middle pane displays the source of the method. Note that this is not intended for editing.
 - The right pane displays a bytecode disassembly for the method.
	
Selecting a row will make corresponding source and instruction selections in the next two panes using essentially the same code as the Debugger. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:
```
	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]
```
Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose DebugInfoPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!

!DebugInfoPlugin categoriesForClass!Browser-Plugins! !

!DebugInfoPlugin methodsFor!

clear
	disassemblyPresenter text: ''.
	sourcePresenter text: ''.
	textMapPresenter list: #()!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	disassemblyPresenter := self add: Smalltalk developmentSystem workspaceClass new name: 'disassembly'.
	sourcePresenter := self add: Smalltalk developmentSystem methodWorkspaceClass new name: 'source'.
	sourcePresenter isAutoParseEnabled: false.
	textMapPresenter := self add: ListPresenter new name: 'textMap'.
	toggleDebugPresenter := self add: BooleanPresenter new name: 'debugToggle'.
	toggleOptimisedPresenter := self add: BooleanPresenter new name: 'optimisedToggle'.
	toggleOptimisedPresenter value: true!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	(self model)
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self;
		when: #classSelected
			send: #onBrowserClassSelected
			to: self.
	textMapPresenter 
		when: #selectionChanged
		send: #onTextMapEntrySelected
		to: self.
	toggleDebugPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self.
	toggleOptimisedPresenter 
		when: #valueChanged
		send: #toggleDebug
		to: self!

displayMethod
	| debugInfo |
	method := self selectedMethod.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	debugInfo := self getDebugInfoFor: method.
	method := debugInfo method.
	method isNil 
		ifTrue: 
			[self clear.
			^self].
	disassemblyPresenter text: method disassembly.
	textMapPresenter list: debugInfo textMap!

displayOn: aStream
	"Append, to aStream, a String whose characters are a representation of the receiver as a user
	would want to see it. This will be used as the label for the tab when the receiver is being displayed
	as a plugin within the Class Browser"

	aStream nextPutAll: 'Debug Info.'!

getDebugInfoFor: aCompiledMethod 
	| methodClass compiler flags |
	methodClass := aCompiledMethod methodClass.
	compiler := aCompiledMethod compilerClass.
	flags := methodClass defaultCompilationFlags 
				| (compiler debugInfoFlags: toggleDebugPresenter value).
	flags := flags mask: CompilerFlags.NoOptimize set: toggleOptimisedPresenter value not.
	^compiler 
		compile: aCompiledMethod getSource
		in: methodClass
		flags: flags!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	self displayMethod!

onTextMapEntrySelected
	"Private - Similar to the logic in Debugger"

	| ip mapEntry |
	mapEntry := textMapPresenter selectionOrNil.
	mapEntry isNil 
		ifTrue: 
			[disassemblyPresenter selectionRange: (1 to: 0).
			sourcePresenter selectionRange: (1 to: 0).
			^self].
	ip := mapEntry key.
	"There are two lines of header text before the bytecode disassembly starts"
	disassemblyPresenter selectLine: (method indexOfIP: ip) + 2.
	disassemblyPresenter view ensureCaretVisible.
	sourcePresenter selectionRange: mapEntry value!

parseContext
	^self browser parseContext!

selectedMethod
	^self browser selectedMethod 
		ifNotNil: [:m | toggleDebugPresenter value ifTrue: [m asDebugMethod] ifFalse: [m]]!

toggleDebug
	| sel |
	sel := textMapPresenter selectionByIndex.
	self displayMethod.
	textMapPresenter selectionByIndex: sel ifAbsent: []! !

!DebugInfoPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!private! !
displayOn:!displaying!public! !
getDebugInfoFor:!private! !
onBrowserClassSelected!event handling!public! !
onBrowserMethodSelected!event handling!public! !
onTextMapEntrySelected!private! !
parseContext!public! !
selectedMethod!public! !
toggleDebug!public! !
!

!DebugInfoPlugin class methodsFor!

icon
	"Answers an Icon that can be used to represent this class"

	^##(self) defaultIcon!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	ViewComposer openOn: (ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 4 788558 11 ##(Smalltalk.STBViewProxy) ##(Smalltalk.ContainerView) 34 15 nil nil 34 2 8 1409286144 131073 416 nil nil nil 5 nil nil nil 416 1180166 ##(Smalltalk.ProportionalLayout) 170 176 34 8 410 ##(Smalltalk.ContainerView) 34 15 nil 416 34 2 8 1140850688 131073 544 nil nil nil 5 nil nil nil 544 788230 ##(Smalltalk.BorderLayout) 1 1 410 ##(Smalltalk.ContainerView) 34 15 nil 544 34 2 8 1140850688 131073 640 nil nil nil 5 nil nil nil 640 656198 1 ##(Smalltalk.FlowLayout) 1 1 1 170 192 34 4 410 ##(Smalltalk.CheckBox) 34 16 nil 640 34 2 8 1409363203 1 768 721990 2 ##(Smalltalk.ValueHolder) nil nil 1114118 ##(Smalltalk.NeverSearchPolicy) false nil nil 5 nil nil nil 768 nil 8 1759007584 852486 ##(Smalltalk.NullConverter) nil nil nil 983302 ##(Smalltalk.MessageSequence) 138 144 34 1 721670 ##(Smalltalk.MessageSend) #createWindow: 34 1 787462 ##(Smalltalk.CreateWindow) 262406 ##(Smalltalk.RECT) 8 #[2 0 0 0 0 0 0 0 67 0 0 0 25 0 0 0] 193 800 8 'Debug?' 768 3 8 #() 328198 ##(Smalltalk.Point) 193 193 nil 27 8 'debugToggle' 410 ##(Smalltalk.CheckBox) 34 16 nil 640 34 2 8 1409363203 1 1216 834 nil nil 880 false nil nil 5 nil nil nil 1216 nil 8 1759007584 914 nil nil nil 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[67 0 0 0 0 0 0 0 152 0 0 0 25 0 0 0] 193 1248 8 'Optimised?' 1216 3 8 #() 1170 193 193 nil 27 8 'optimisedToggle' 590342 ##(Smalltalk.Rectangle) 1170 5 1 1170 1 1 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[0 0 0 0 0 0 0 0 158 0 0 0 25 0 0 0] 193 672 8 '' 640 3 34 2 768 1216 1170 193 193 nil 27 nil nil nil 410 ##(Smalltalk.ListView) 34 45 nil 544 34 2 8 1409388621 1 1760 590662 2 ##(Smalltalk.ListModel) 138 144 8 #() nil 1310726 ##(Smalltalk.IdentitySearchPolicy) 327686 ##(Smalltalk.Color) #default nil 5 nil nil nil 1760 nil 8 1759068368 459270 ##(Smalltalk.Message) #displayString 8 #() nil 1049926 1 ##(Smalltalk.IconImageManager) nil nil nil nil nil nil 138 144 34 2 920646 5 ##(Smalltalk.ListViewColumn) 8 'IP' 87 #left 1970 #displayString 2000 1970 #<= 8 #() 787814 3 ##(Smalltalk.BlockClosure) 0 nil 1180966 ##(Smalltalk.CompiledExpression) 2 1 ##(Smalltalk.UndefinedObject) 8 'doIt' 8 '[:each | each key]' 8 #[30 105 226 0 106] #key 2192 7 257 nil nil 1760 nil 1 nil nil 2082 8 'Range' 223 #left 1970 #displayString 8 #() 1970 #<= 2336 2178 0 nil 2210 1 83886081 ##(Smalltalk.UndefinedObject) 8 'doIt' 8 '[:each | each value]' 8 #[29 105 17 142 106] 2368 7 257 nil nil 1760 nil 3 nil nil #report 8 #() nil 131169 nil 1 nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[0 0 0 0 25 0 0 0 158 0 0 0 114 1 0 0] 193 1792 8 'IP' 1760 3 8 #() 1170 193 193 nil 35 170 192 34 2 1760 8 'textMap' 1522 1170 1 1 1170 5 1 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[0 0 0 0 0 0 0 0 160 0 0 0 114 1 0 0] 193 576 8 '' 544 3 34 2 640 1760 1170 193 193 nil 27 1 410 ##(Smalltalk.StaticRectangle) 34 14 nil 416 34 2 8 1140850952 1 2912 nil 1936 nil 5 nil nil nil 2912 nil 8 1759212608 946 138 144 34 2 1010 #createWindow: 34 1 1058 1090 8 #[160 0 0 0 0 0 0 0 161 0 0 0 114 1 0 0] 193 2944 nil 2912 1010 #isEnabled: 8 #(false) 2912 3 8 #() 1170 193 193 nil 27 1 410 ##(Smalltalk.ScintillaView) 34 65 nil 416 34 2 8 1445007684 1 3184 nil 1936 nil 21 265030 4 ##(Smalltalk.Menu) nil true 34 9 3250 nil true 34 3 984134 2 ##(Smalltalk.CommandMenuItem) 1 1180998 4 ##(Smalltalk.CommandDescription) #copySelection 8 '&Copy' 1 1 263494 3 ##(Smalltalk.Icon) nil true 1572870 ##(Smalltalk.ImageRelativeFileLocator) 8 'EditCopy.ico' 2032142 ##(Smalltalk.STBExternalResourceLibraryProxy) 8 'dolphindr7.dll' nil nil nil 983366 1 ##(Smalltalk.DividerMenuItem) 4097 3330 1 3362 #selectAll 8 '&Select All' 1 1 nil nil nil 8 '&Edit' nil 134217729 nil nil nil nil nil 3250 nil true 34 6 3330 1 3362 #toggleIndentationGuides 8 'Indentation &Guides' 1 1 nil nil nil 3330 1 3362 #toggleLineNumbers 8 'Line N&umbers' 1 1 nil nil nil 3330 1 3362 #toggleLineEndings 8 'Line &Endings' 1 1 nil nil nil 3330 1 3362 #toggleStyling 8 '&Syntax Coloring' 1 1 nil nil nil 3330 1 3362 #toggleWhitespace 8 'W&hitespace' 1 1 nil nil nil 3330 1 3362 #toggleWordWrap 8 '&Word Wrap' 1 1 nil nil nil 8 'Wor&kspace' nil 134217729 nil nil nil nil nil 3538 4097 3330 1 3362 #browseIt 8 'Bro&wse It' 1 1 3410 nil true 3456 8 'ClassBrowserShell.ico' 3504 nil nil 3330 1 3362 #evaluateIt 8 'E&valuate It' 1 1 3410 nil true 3456 8 'EvaluateIt.ico' 3504 nil nil 3330 1 3362 #inspectIt 8 '&Inspect It' 1 1 3410 nil true 3456 8 'InspectIt.ico' 3504 nil nil 3330 1 3362 #debugIt 8 'Deb&ug It' 1 1 3410 nil true 3456 8 'Debugger.ico' 3504 nil nil 3538 4097 3250 nil true 34 4 3330 2097153 3362 #browseDefinitions 8 'Defi&nitions of <1d>' 1 1 nil nil nil 3330 1 3362 #browseReferences 8 '&References to <1d>' 1 1 nil nil nil 3538 4097 3330 1 3362 #browseMessage 8 '<1d>' 1 1 nil nil nil 8 '&Browse' nil 1 nil nil nil nil nil 8 '&Workspace' nil 134217729 nil nil nil nil nil nil nil 3184 nil 8 1504001512 914 nil nil 11 68802481 170 192 34 4 #callTip 1182790 1 ##(Smalltalk.ScintillaTextStyle) 77 1922 #gray 1922 #white 1 nil nil nil nil #callTip nil nil nil #normal 4610 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1377542 ##(Smalltalk.SmalltalkMethodStyler) 1 nil nil false 138 144 1872 170 192 34 2 #default 1641542 2 ##(Smalltalk.ScintillaMarkerDefinition) 1 nil nil nil 3184 #circle nil nil nil nil nil nil 138 ##(Smalltalk.IdentitySet) 1872 nil 170 176 1872 9215 nil nil nil nil 1922 #silver nil nil 65 nil nil 170 192 34 6 #specialCharacter 8 '()[]<>' #literalArray 8 '()' #literalBytes 8 '[]' 8 '' 3 170 192 34 2 #container 4576 nil nil nil nil 208 nil 170 192 34 4 #Warning 1510470 3 ##(Smalltalk.ScintillaIndicatorStyle) 17 3184 1922 #blue 3 false #Warning nil nil nil nil nil nil #Error 5010 19 3184 1922 #red 3 false #Error nil nil nil nil nil nil nil nil 170 192 34 6 #Warning 4610 1027 1922 #darkGoldenrod 1922 #ivory 1 nil nil nil nil #Warning nil nil nil #Error 4610 1031 1922 #firebrick 1922 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 4610 1029 nil 1922 #gainsboro 1 nil nil nil nil #Notification nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 946 138 144 34 10 1010 #createWindow: 34 1 1058 1090 8 #[161 0 0 0 0 0 0 0 214 1 0 0 114 1 0 0] 193 3216 nil 3184 1010 #contextMenu: 34 1 3264 3184 1010 #hoverTime: 8 #(500) 3184 1010 #caretPeriod: 8 #(530) 3184 1010 #wordWrap: 8 #(true) 3184 1010 #margins: 34 1 34 3 985158 3 ##(Smalltalk.ScintillaMargin) 1 3184 33 3 nil nil nil nil 5554 3 3184 1 nil nil 67108863 nil nil 5554 5 3184 1 nil nil nil nil nil 3184 1010 #backspaceUnindents: 8 #(true) 3184 1010 #targetRange: 34 1 525062 ##(Smalltalk.Interval) 1 -1 3 3184 1010 #maxCompletionListHeight: 8 #(9) 3184 1010 #edgeColumn: 8 #(1) 3184 3 8 #() 1170 193 193 nil 33 9 410 ##(Smalltalk.ScintillaView) 34 65 nil 416 34 2 8 1174475012 1 5808 834 nil false 1310726 ##(Smalltalk.EqualitySearchPolicy) nil 1922 #highlight3d nil 1045 nil nil nil 5808 nil 8 1504001512 914 nil nil 11 68798113 170 192 34 10 #indentGuide 4610 75 nil nil 1 nil nil nil nil #indentGuide nil nil nil #lineNumber 4610 67 nil nil 1 nil nil nil nil #lineNumber nil nil nil #normal 4610 1 nil nil 1 nil nil nil nil #normal nil nil nil #callTip 4610 77 4640 4656 1 nil nil nil nil #callTip nil nil nil #whitespace 4610 3 nil nil 1 nil nil nil nil #whitespace nil nil nil nil 1245510 1 ##(Smalltalk.NullScintillaStyler) #normal 170 192 34 2 #default 4770 1 nil nil nil 5808 #circle nil nil nil nil nil nil 138 ##(Smalltalk.IdentitySet) 1872 nil 170 176 1872 9215 nil nil nil nil 4832 nil nil 65 nil nil nil 8 '' 1 170 192 34 2 #container 5968 nil nil nil nil 208 nil 170 192 1872 nil nil 170 192 34 6 #Warning 4610 1027 5136 5152 1 nil nil nil nil #Warning nil nil nil #Error 4610 1031 5184 5200 1 nil nil nil nil #Error nil nil nil #Notification 4610 1029 nil 5232 1 nil nil nil nil #Notification nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 946 138 144 34 8 1010 #createWindow: 34 1 1058 1090 8 #[219 1 0 0 0 0 0 0 17 3 0 0 114 1 0 0] 193 5840 nil 5808 1010 #caretPeriod: 8 #(530) 5808 1010 #wordWrap: 8 #(true) 5808 1010 #margins: 34 1 34 3 5554 1 5808 1 3 nil nil nil nil 5554 3 5808 1 nil nil 67108863 nil nil 5554 5 5808 1 nil nil nil nil nil 5808 1010 #canHScroll: 8 #(false) 5808 1010 #targetRange: 34 1 5682 1 -1 3 5808 1010 #maxCompletionListHeight: 8 #(9) 5808 1010 #edgeColumn: 8 #(1) 5808 3 8 #() 1170 193 193 nil 33 9 false 170 192 34 4 5808 8 'disassembly' 3184 8 'source' nil 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[191 13 0 0 10 0 0 0 208 16 0 0 124 1 0 0] 193 448 8 '' 416 1 34 5 544 2912 3184 410 ##(Smalltalk.Splitter) 34 12 nil 416 34 2 8 1140850688 1 7024 nil nil nil 517 nil nil nil 1510470 1 ##(Smalltalk.DraggableViewInteractor) 7024 nil 1 #left nil nil nil 1170 1 1 1170 9 9 nil 7120 nil 946 138 144 34 1 1010 #createWindow: 34 1 1058 1090 8 #[214 1 0 0 0 0 0 0 219 1 0 0 114 1 0 0] 193 7056 8 '' 7024 3 8 #() 1170 193 193 nil 27 5808 1170 193 193 nil 27 )! !

!DebugInfoPlugin class categoriesForMethods!
icon!constants!public! !
resource_Default_view!public!resources-views! !
!

