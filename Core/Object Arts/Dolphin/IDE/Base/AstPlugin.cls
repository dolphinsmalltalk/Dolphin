"Filed out from Dolphin Smalltalk"!

ClassBrowserPlugin subclass: #AstPlugin
	instanceVariableNames: 'astPresenter sourcePresenter'
	classVariableNames: ''
	poolDictionaries: ''
	classInstanceVariableNames: ''!

AstPlugin guid: (GUID fromString: '{4aba7565-bc07-4387-b7e4-16e2f57f1801}')!

AstPlugin comment: 'AstPlugin is a <classBrowserPlugin> that displays the syntax tree for the currently selected method alongside the source.
	
Selecting a node will select the corresponding range of source. The Debug and Optimized checkboxes can be toggled to see the effect on the generated bytecodes, although note that Debug methods are never optimized.

Since this facility is probably not of interest to most developers it is not installed as one of the default plugins. If you wish to add this plugin to all browsers please evaluate:

	ClassBrowserAbstract allSubclasses do: [:each | each plugins add: self]

Alternatively Tools/Options/Inspect Options, then double click plugins, press the * button, and choose AstPlugin from the list, Ok out. The plugin will appear in any subsequently opened browser.'!

!AstPlugin categoriesForClass!MVP-Presenters! !

!AstPlugin methodsFor!

clear
	sourcePresenter text: ''.
	astPresenter model clear!

createComponents
	"Create the presenters contained by the receiver"

	super createComponents.
	astPresenter := self add: TreePresenter new name: 'syntaxTree'.
	sourcePresenter := self add: Smalltalk developmentSystem methodWorkspaceClass new name: 'source'.
	sourcePresenter isAutoParseEnabled: false.!

createSchematicWiring
	"Create the trigger wiring for the receiver"

	super createSchematicWiring.
	astPresenter
		when: #selectionChanged
		send: #onNodeSelected
		to: self.
	(self model)
		when: #classSelected
			send: #onBrowserClassSelected
			to: self;
		when: #methodSelected
			send: #onBrowserMethodSelected
			to: self!

displayMethod
	| treeModel method |
	method := self selectedMethod.
	method isNil
		ifTrue: 
			[self clear.
			^self].
	sourcePresenter text: method getSource.
	treeModel := VirtualTreeModel withRoots: (OrderedCollection with: self browser parseTree).
	astPresenter model: treeModel!

displayOn: aWriteStream 
	^aWriteStream nextPutAll: 'Syntax Tree'!

onBrowserClassSelected
	self isCurrentCard ifTrue: [self browser ensureDefinitionVisible]!

onBrowserMethodSelected
	"Event handler for a method being selected within the receiver's associated browser. "

	self isCurrentCard ifTrue: [self displayMethod]!

onNodeSelected
	sourcePresenter
		selectionRange: (astPresenter selection ifNil: [1 to: 0] ifNotNil: [:node | node sourceInterval])!

onShownInBrowser
	"Event handler indicating that the receiver has been displayed within it's browser. "

	super onShownInBrowser.
	"For efficiency we defer the creation of the diagram until the receiver becomes the current card"
	self displayMethod!

selectedMethod
	^self browser selectedMethod! !

!AstPlugin categoriesForMethods!
clear!private! !
createComponents!initializing!public! !
createSchematicWiring!initializing!public! !
displayMethod!operations!private! !
displayOn:!public! !
onBrowserClassSelected!event handling!private! !
onBrowserMethodSelected!event handling!private! !
onNodeSelected!event handling!private! !
onShownInBrowser!event handling!public! !
selectedMethod!accessing!private! !
!

!AstPlugin class methodsFor!

resource_Default_view
	"Answer the literal data from which the 'Default view' resource can be reconstituted.
	DO NOT EDIT OR RECATEGORIZE THIS METHOD.

	If you wish to modify this resource evaluate:
	ViewComposer openOn: (ResourceIdentifier class: self selector: #resource_Default_view)
	"

	^#(#'!!STL' 4 788558 11 ##(Smalltalk.STBViewProxy) ##(Smalltalk.ContainerView) 34 15 nil nil 34 2 8 1409286144 131073 416 nil nil nil 5 nil nil nil 416 1180166 ##(Smalltalk.ProportionalLayout) 170 176 8 #() true 170 192 34 4 410 ##(Smalltalk.ScintillaView) 34 65 nil 416 34 2 8 1445007428 262145 576 721990 2 ##(Smalltalk.ValueHolder) nil false 1310726 ##(Smalltalk.EqualitySearchPolicy) nil 655878 ##(Smalltalk.ThemeColor) #smalltalkWorkspace nil 5 nil nil nil 576 nil 8 1504001512 852486 ##(Smalltalk.NullConverter) nil nil 9 68798113 170 192 34 4 #callTip 1182790 1 ##(Smalltalk.ScintillaTextStyle) 77 327686 ##(Smalltalk.Color) #gray 850 #white 1 nil nil nil nil #callTip nil nil nil #normal 818 1 nil nil 1 nil nil nil nil #normal nil nil nil nil 1377542 ##(Smalltalk.SmalltalkMethodStyler) 1 nil nil false 138 144 528 170 192 34 2 #default 1641542 2 ##(Smalltalk.ScintillaMarkerDefinition) 1 nil nil nil 576 #circle nil nil nil nil nil nil 138 ##(Smalltalk.IdentitySet) 528 nil 170 176 528 9215 nil nil nil nil 850 #silver nil nil 65 nil nil 170 192 34 6 #specialCharacter 8 '()[]<>' #literalArray 8 '()' #literalBytes 8 '[]' 8 '' 3 170 192 34 2 #container 784 nil nil nil nil 16 nil 170 192 34 6 1 1510470 3 ##(Smalltalk.ScintillaIndicatorStyle) 1 576 850 #commonGreen 3 false 1 nil nil nil nil nil nil 3 1234 3 576 850 #blue 5 false 3 nil nil nil nil nil nil 5 1234 5 576 850 #red 1 false 5 nil nil nil nil nil nil nil nil 170 192 34 6 #Warning 818 1027 850 #darkGoldenrod 850 #ivory 1 nil nil nil nil #Warning nil nil nil #Error 818 1031 850 #firebrick 850 #floralWhite 1 nil nil nil nil #Error nil nil nil #Notification 818 1029 nil 850 #gainsboro 1 nil nil nil nil #Notification nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil nil 983302 ##(Smalltalk.MessageSequence) 138 144 34 7 721670 ##(Smalltalk.MessageSend) #createWindow: 34 1 787462 ##(Smalltalk.CreateWindow) 262406 ##(Smalltalk.RECT) 8 #[0 0 0 0 127 0 0 0 94 1 0 0 250 0 0 0] 193 608 nil 576 1570 #caretPeriod: 8 #(530) 576 1570 #margins: 34 1 34 3 985158 3 ##(Smalltalk.ScintillaMargin) 1 576 1 3 nil nil nil nil 1778 3 576 33 nil 3 67108863 nil nil 1778 5 576 1 nil 3 -67108863 nil nil 576 1570 #tabWidth: 8 #(4) 576 1570 #targetRange: 34 1 525062 ##(Smalltalk.Interval) 1 -1 3 576 1570 #maxCompletionListHeight: 8 #(9) 576 1570 #edgeColumn: 8 #(1) 576 3 8 #() 328198 ##(Smalltalk.Point) 193 193 nil 33 8 'source' 410 ##(Smalltalk.MoenTreeView) 34 30 nil 416 34 2 8 1409286144 262145 2064 590918 3 ##(Smalltalk.TreeModel) nil 1310726 ##(Smalltalk.IdentitySearchPolicy) 525062 ##(Smalltalk.TreeNode) nil nil nil 170 192 528 850 #default nil 517 nil nil nil 2064 788998 ##(Smalltalk.MoenTreeNode) nil 721926 ##(Smalltalk.MoenContour) nil nil nil nil 2018 1 1 2320 nil nil nil nil nil 7 459270 ##(Smalltalk.Message) #displayString 8 #() ##(Smalltalk.MoenTreeView) 268435457 2018 5 3 1049926 1 ##(Smalltalk.IconImageManager) 2018 1 1 41 nil 197382 ##(Smalltalk.Pen) nil true 393478 ##(Smalltalk.LOGPEN) 8 #[0 0 0 0 1 0 0 0 0 0 0 0 192 192 192 0] 2018 33 33 2018 19999 19999 114721 2432 2018 35 1 nil nil nil 1506 138 144 34 1 1570 #createWindow: 34 1 1618 1650 8 #[0 0 0 0 0 0 0 0 94 1 0 0 122 0 0 0] 193 2096 8 '' 2064 3 8 #() 2018 193 193 nil 27 8 'syntaxTree' nil 1506 138 144 34 1 1570 #createWindow: 34 1 1618 1650 8 #[191 13 0 0 10 0 0 0 29 15 0 0 4 1 0 0] 193 448 8 '' 416 1 34 3 2064 410 ##(Smalltalk.Splitter) 34 12 nil 416 34 2 8 1140850688 1 2928 nil nil nil 517 nil nil nil 1510470 1 ##(Smalltalk.DraggableViewInteractor) 2928 nil 1 #left nil nil nil 2018 1 1 2018 9 9 nil 3024 nil 1506 138 144 34 1 1570 #createWindow: 34 1 1618 1650 8 #[0 0 0 0 122 0 0 0 94 1 0 0 127 0 0 0] 193 2960 8 '' 2928 3 8 #() 2018 193 193 nil 27 576 2018 193 193 nil 27 )! !

!AstPlugin class categoriesForMethods!
resource_Default_view!public!resources-views! !
!

