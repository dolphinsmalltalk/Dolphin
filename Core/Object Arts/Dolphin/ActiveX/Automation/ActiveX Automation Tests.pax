| package |
package := Package name: 'ActiveX Automation Tests'.
package paxVersion: 2.1;
	preDeclareClassesOnLoad: false;
	basicComment: ''.


package setClassNames: #(
	#{Smalltalk.BSTRTest}
	#{Smalltalk.IDispatchTest}
	#{Smalltalk.SAFEARRAYTest}
	#{Smalltalk.VARIANTTest}
).

package setMethodNames: #(
	#(#{External.Tests.AddressTest} #testBSTRFromAddress)
	#(#{External.Tests.FunctionDescriptorTest} #testComPtrs)
	#(#{External.Tests.StructureTest} #testExtendedErrorInfo)
).

package setPrerequisites: #(
	'ActiveX Automation'
	'..\Components\Scripting\ActiveX Scripting'
	'..\ActiveX Tests'
	'..\..\..\Samples\ActiveX\Random\COM Random Stream'
	'..\..\Base\Dolphin'
	'..\..\Base\Dolphin Base Tests'
	'..\..\MVP\Base\Dolphin Basic Geometry'
	'..\COM\OLE COM'
).

package!

"Class Definitions"!

Core.Tests.DolphinTest subclass: #BSTRTest
	instanceVariableNames: ''
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Core.Tests.DolphinTest subclass: #IDispatchTest
	instanceVariableNames: ''
	classVariableNames: ''
	imports: #()
	classInstanceVariableNames: ''
	classConstants: {}!
Core.Tests.DolphinTest subclass: #VARIANTTest
	instanceVariableNames: ''
	classVariableNames: ''
	imports: #(#{Smalltalk.AXAutomationConstants})
	classInstanceVariableNames: ''
	classConstants: {}!
External.Tests.GenericExternalArrayTest subclass: #SAFEARRAYTest
	instanceVariableNames: ''
	classVariableNames: ''
	imports: #(#{OS.Win32Errors})
	classInstanceVariableNames: ''
	classConstants: {}!

"Loose Methods"!

!External.Tests.AddressTest methodsFor!

testBSTRFromAddress
	| empty |
	self stringFromAddressTestClass: Smalltalk.BSTR.
	"By convention, a null BSTR is equivalent to the empty string"
	empty := Smalltalk.BSTR new.
	self assert: (Smalltalk.BSTR fromAddress: nil) equals: empty.
	self assert: (Smalltalk.BSTR fromAddress: 0) equals: empty! !
!External.Tests.AddressTest categoriesFor: #testBSTRFromAddress!public!unit tests! !

!External.Tests.FunctionDescriptorTest methodsFor!

testComPtrs
	self
		parseStructArg: Smalltalk.IUnknown
		valueType: ExtCallArgSTRUCT
		refType: ExtCallArgCOMPTR.
	self
		parseStructArg: Smalltalk.IDispatch
		valueType: ExtCallArgSTRUCT
		refType: ExtCallArgCOMPTR! !
!External.Tests.FunctionDescriptorTest categoriesFor: #testComPtrs!public!unit tests! !

!External.Tests.StructureTest methodsFor!

testExtendedErrorInfo
	"Tests that extended error info is accessed on failed external API calls through COM interfaces if the target object supports it."

	| script errorInfo error |
	script := Smalltalk.IScriptControl new.
	self assert: script supportsErrorInfo.
	errorInfo := [script eval: '1+2'] on: HRESULTError do: [:ex | ex errorInfo].
	self assert: errorInfo notNil.
	self assert: errorInfo source equals: 'ScriptControl'.
	self assert: errorInfo guid equals: Smalltalk.IScriptControl guid.
	script free.
	error := [script eval: '1+2'] on: HRESULTError do: [:ex | ex].
	self assertIsNil: error errorInfo.
	self assert: error hresult
		equals: (HRESULT fromPrimitiveFailureCode: _PrimitiveFailureCode.InvalidPointer)! !
!External.Tests.StructureTest categoriesFor: #testExtendedErrorInfo!public!unit tests! !

"End of package definition"!

